//
//  RMMediaCollectionViewCell.m
//  Redmadrobot
//
//  Created by Dmitry Shashlov on 11/20/14.
//  Copyright (c) 2014 Dmitry Shashlov. All rights reserved.
//

#import "RMMediaCollectionViewCell.h"

static UIImage *__placeholderImage = nil;

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

@interface RMMediaCollectionViewCell()
@property (nonatomic) UIImageView *imageView;
@end

@implementation RMMediaCollectionViewCell

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#pragma mark - Load

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+ (void)load
{
  [super load];
  __placeholderImage = [UIImage imageNamed:@"Placeholder"];
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#pragma mark - Init

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
- (instancetype)initWithFrame:(CGRect)frame
{
  self = [super initWithFrame:frame];
  if (self)
  {
    // Image view
    _imageView = [[UIImageView alloc] initWithFrame:self.bounds];
    _imageView.image = __placeholderImage;
    _imageView.clipsToBounds = YES;
    [self.contentView addSubview:_imageView];
  }
  return self;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#pragma mark - Setters

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
- (void)setMedia:(InstagramMedia *)media
{
  if (![_media.Id isEqualToString:media.Id])
  {
    _media = media;
    _imageView.image = __placeholderImage;    
    // NSLog(@"Download thumbnail: [%@] %@", _media.Id, _media.thumbnailURL);
    
    // Download thumbnail image
    [[NSData rac_readContentsOfURL:_media.thumbnailURL
                           options:0
                         scheduler:[RACScheduler schedulerWithPriority:RACSchedulerPriorityBackground]]
     subscribeNext:^(NSData *data) {
       dispatch_async(dispatch_get_main_queue(), ^{
         // NSLog(@"Download finished: [%@] %@", _media.Id, _media.thumbnailURL);
         _imageView.image = [UIImage imageWithData:data];
       });
     } error:^(NSError *error) {
       NSLog(@"%@", error.localizedDescription);
     }];
  }
}

@end
